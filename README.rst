===============
NLDI Flow Tools
===============

.. image:: https://img.shields.io/travis/Anders-Hopkins/nldi_flowtools.svg
        :target: https://travis-ci.org/Anders-Hopkins/nldi_flowtools

.. image:: https://img.shields.io/pypi/v/nldi_flowtools.svg
        :target: https://pypi.python.org/pypi/nldi_flowtools


NLDI Flow Tools pulls from the NHD to delineate water flow paths and drainage basins from a lon, lat point.

* Free software: 3-clause BSD license
* Documentation: https://nldi-flowtools.readthedocs.io/

Install
------
* conda create -n env_name -c conda-forge python=3.8 gdal rasterio proj=6.2.1
* conda activate env_name
* pip install git+https://github.com/ACWI-SSWD/nldi_flowtools.git

Features
--------

* Splitcatchment delineates drainage basins from an input pour point.
* Flowtrace traces the flowpath of water from an input point to the nearest stream.

Split Catchment Tool
-----------------------


To find the catchment from a lon, lat point, use the splitcatchment() function. The first two inputs are the inputs are the longitude and latitude coordinates passed in as floats. The third input is the 'upstream' variable, which is passed as a boolean. If this is set to True, and the input point lands on an NHD Flowline, then the function will return both the local catchment geometry, and the 'mergedcatchment' geometry (the splitcatchment merged with all upstream catchments).

.. code-block:: python

    from nldi_flowtools import *
    splitcatchment(-93.02933761928982, 41.79037842455216, True)
    
This splitcatchment function returns the following response in GeoJson.    
        
.. image:: https://github.com/ACWI-SSWD/nldi_flowtools/blob/master/docs/images/splitcatchment1.png
   :width: 200

.. code-block:: python

        {"features": [{"geometry": {"coordinates": [[[-93.0451, 41.7848], [-93.0447, 41.7856], [-93.0443, 41.7885], [-93.044, 41.7887], [-93.0422, 41.7885], [-93.0411, 41.788], [-93.0394, 41.7883], [-93.0366, 41.7885], [-93.0376, 41.7914], [-93.0366, 41.792], [-93.0367, 41.7922], [-93.0362, 41.7927], [-93.0359, 41.7936], [-93.0357, 41.794], [-93.0338, 41.795], [-93.0332, 41.7967], [-93.0324, 41.7975], [-93.032, 41.7985], [-93.0299, 41.7991], [-93.0287, 41.8001], [-93.0282, 41.8025], [-93.028, 41.8029], [-93.0275, 41.8032], [-93.027, 41.8058], [-93.0242, 41.8056], [-93.0231, 41.8062], [-93.0216, 41.8074], [-93.0168, 41.8057], [-93.0166, 41.8056], [-93.017, 41.8053], [-93.0177, 41.8048], [-93.0187, 41.8023], [-93.0198, 41.8009], [-93.0203, 41.7999], [-93.0212, 41.799], [-93.0226, 41.7986], [-93.0231, 41.7982], [-93.0237, 41.7973], [-93.0243, 41.7965], [-93.0252, 41.791], [-93.0241, 41.7895], [-93.0239, 41.7889], [-93.0255, 41.7867], [-93.0271, 41.7853], [-93.0276, 41.7843], [-93.0283, 41.7832], [-93.0295, 41.7825], [-93.0307, 41.7814], [-93.0324, 41.7811], [-93.0328, 41.7812], [-93.0329, 41.781], [-93.0339, 41.7815], [-93.0357, 41.7806], [-93.0369, 41.7814], [-93.0379, 41.7809], [-93.0393, 41.7811], [-93.0409, 41.781], [-93.0421, 41.7811], [-93.0425, 41.7836], [-93.0445, 41.7846], [-93.0451, 41.7848]]], "type": "Polygon"}, "id": "catchment", "properties": {"catchmentID": "6995139"}, "type": "Feature"}, {"geometry": {"coordinates": [[[-93.257428, 42.012265], [-93.259068, 42.012905], [-93.258845, 42.014181], [-93.254075, 42.014358], [-93.250066, 42.018307], [-93.246919, 42.019059], [-93.240156, 42.019215], [-93.228355, 42.018733], [-93.226305, 42.020763], [-93.226289, 42.022058], [-93.224857, 42.023646], [-93.221215, 42.025116], [-93.219247, 42.023415], [-93.215159, 42.02356], [-93.213355, 42.024423], [-93.209426, 42.024108], [-93.208448, 42.022719], [-93.209365, 42.021571], [-93.208321, 42.020015], [-93.211482, 42.017497], [-93.209729, 42.014445], [-93.206824, 42.013677], [-93.204216, 42.011771], [-93.204876, 42.009364], [-93.204271, 42.007802], [-93.192825, 42.007709], [-93.188849, 42.004478], [-93.185446, 42.003585], [-93.184356, 42.002371], [-93.180124, 42.000927], [-93.170757, 41.995072], [-93.168533, 41.994486], [-93.166935, 41.992246], [-93.167002, 41.987979], [-93.1624, 41.986569], [-93.158503, 41.982187], [-93.156088, 41.980619], [-93.152329, 41.979965], [-93.146563, 41.980221], [-93.144852, 41.97652], [-93.14335, 41.975843], [-93.140662, 41.974863], [-93.138481, 41.974949], [-93.136609, 41.977092], [-93.131709, 41.975323], [-93.130689, 41.974141], [-93.128645, 41.974138], [-93.124389, 41.971291], [-93.120623, 41.972151], [-93.114173, 41.969751], [-93.111145, 41.970581], [-93.107672, 41.969977], [-93.103841, 41.970953], [-93.099492, 41.967659], [-93.097453, 41.967588], [-93.092111, 41.965712], [-93.091773, 41.962889], [-93.093216, 41.961352], [-93.090942, 41.959259], [-93.083098, 41.956473], [-93.076005, 41.956368], [-93.073813, 41.957405], [-93.070538, 41.957387], [-93.06575, 41.954341], [-93.065981, 41.95162], [-93.063379, 41.948481], [-93.061351, 41.949439], [-93.0573, 41.949422], [-93.056089, 41.948144], [-93.056448, 41.947272], [-93.055753, 41.94601], [-93.056795, 41.944904], [-93.056185, 41.943701], [-93.053912, 41.942931], [-93.052112, 41.941115], [-93.049312, 41.940999], [-93.047354, 41.941998], [-93.043458, 41.941055], [-93.041089, 41.94251], [-93.036536, 41.942846], [-93.035798, 41.944334], [-93.033203, 41.944436], [-93.032191, 41.942932], [-93.033021, 41.941694], [-93.027474, 41.937559], [-93.029151, 41.934715], [-93.023186, 41.932237], [-93.021106, 41.929775], [-93.0127, 41.929619], [-93.008001, 41.927576], [-93.007636, 41.921595], [-93.008541, 41.920288], [-93.008055, 41.918988], [-93.005604, 41.916726], [-93.006061, 41.91486], [-93.002129, 41.912008], [-93.00115, 41.909436], [-92.995177, 41.907747], [-92.994896, 41.905851], [-92.993089, 41.902813], [-92.982792, 41.896939], [-92.979613, 41.893902], [-92.97678, 41.892212], [-92.971691, 41.892112], [-92.968838, 41.88986], [-92.971938, 41.886014], [-92.971294, 41.884997], [-92.971617, 41.884043], [-92.977416, 41.884261], [-92.979255, 41.883541], [-92.980021, 41.881231], [-92.981288, 41.881339], [-92.983673, 41.879461], [-92.984408, 41.877242], [-92.983382, 41.87557], [-92.985374, 41.874584], [-92.984009, 41.873537], [-92.984273, 41.872485], [-92.986456, 41.871244], [-92.988427, 41.871635], [-92.988854, 41.87064], [-92.985357, 41.867459], [-92.984403, 41.864632], [-92.984607, 41.862087], [-92.980778, 41.860315], [-92.980194, 41.859306], [-92.980765, 41.858111], [-92.977887, 41.854751], [-92.977842, 41.853027], [-92.982096, 41.847858], [-92.981505, 41.845806], [-92.979003, 41.844507], [-92.97838, 41.839871], [-92.979603, 41.83945], [-92.985843, 41.841107], [-92.988772, 41.841024], [-92.989289, 41.839164], [-92.992041, 41.838303], [-92.996995, 41.833296], [-92.996198, 41.829204], [-92.999553, 41.827673], [-93.00482, 41.828375], [-93.005049, 41.827445], [-93.009531, 41.825071], [-93.013977, 41.823971], [-93.016123, 41.821612], [-93.014446, 41.819547], [-93.01643, 41.817942], [-93.019578, 41.817105], [-93.012772, 41.811556], [-93.015205, 41.811312], [-93.017, 41.809893], [-93.014658, 41.807643], [-93.015705, 41.805603], [-93.017571, 41.804719], [-93.02022, 41.799776], [-93.022969, 41.798116], [-93.024196, 41.796476], [-93.025777, 41.796617], [-93.028607, 41.794659], [-93.029107, 41.792427], [-93.028488, 41.791268], [-93.032864, 41.787337], [-93.037021, 41.788458], [-93.041057, 41.788011], [-93.04389, 41.788649], [-93.045684, 41.783641], [-93.051368, 41.783312], [-93.052256, 41.781101], [-93.05451, 41.781331], [-93.056534, 41.78248], [-93.064418, 41.781424], [-93.06522, 41.782431], [-93.065334, 41.784395], [-93.069805, 41.787363], [-93.074579, 41.788566], [-93.076538, 41.7879], [-93.080238, 41.788137], [-93.083268, 41.789867], [-93.088996, 41.791091], [-93.091329, 41.792376], [-93.094969, 41.796525], [-93.100224, 41.799864], [-93.103712, 41.800315], [-93.106188, 41.799474], [-93.107801, 41.799791], [-93.108165, 41.800803], [-93.106656, 41.802705], [-93.109309, 41.804214], [-93.109844, 41.805375], [-93.106198, 41.810232], [-93.105961, 41.813149], [-93.107678, 41.814852], [-93.111934, 41.815311], [-93.113772, 41.816961], [-93.116278, 41.817139], [-93.116872, 41.818965], [-93.11611, 41.81967], [-93.117505, 41.822603], [-93.117276, 41.825446], [-93.120258, 41.825488], [-93.120788, 41.827737], [-93.122435, 41.828891], [-93.126748, 41.828438], [-93.129858, 41.831654], [-93.137646, 41.836103], [-93.143105, 41.840153], [-93.144187, 41.842067], [-93.147766, 41.845329], [-93.149022, 41.849834], [-93.148676, 41.853844], [-93.150318, 41.85508], [-93.150048, 41.857397], [-93.151533, 41.861009], [-93.152547, 41.862134], [-93.155968, 41.862782], [-93.156246, 41.864205], [-93.161902, 41.870231], [-93.161413, 41.872126], [-93.162815, 41.876132], [-93.161381, 41.878519], [-93.161589, 41.879656], [-93.156912, 41.883177], [-93.149569, 41.885656], [-93.1506, 41.888071], [-93.149626, 41.889214], [-93.151953, 41.892738], [-93.151825, 41.894206], [-93.156457, 41.89892], [-93.157235, 41.901689], [-93.156401, 41.90283], [-93.160735, 41.909733], [-93.165428, 41.911244], [-93.167929, 41.913242], [-93.1669, 41.914788], [-93.167855, 41.916801], [-93.167079, 41.919753], [-93.167937, 41.921982], [-93.169495, 41.922129], [-93.170488, 41.924008], [-93.174411, 41.924367], [-93.176327, 41.925591], [-93.182432, 41.92525], [-93.18501, 41.927425], [-93.185071, 41.930718], [-93.183893, 41.932563], [-93.183453, 41.935525], [-93.185613, 41.936876], [-93.188288, 41.93708], [-93.188642, 41.938393], [-93.187506, 41.939356], [-93.188036, 41.941569], [-93.184351, 41.942757], [-93.184751, 41.944255], [-93.180643, 41.946144], [-93.181821, 41.947835], [-93.182663, 41.951864], [-93.181649, 41.953559], [-93.185836, 41.956887], [-93.184368, 41.962235], [-93.189043, 41.965934], [-93.19088, 41.965913], [-93.19596, 41.968669], [-93.198424, 41.969138], [-93.199648, 41.96867], [-93.200286, 41.967242], [-93.205672, 41.966905], [-93.210157, 41.970647], [-93.213521, 41.971275], [-93.213887, 41.972813], [-93.211474, 41.977124], [-93.212459, 41.977474], [-93.216382, 41.976532], [-93.218884, 41.977954], [-93.219523, 41.979976], [-93.221067, 41.980891], [-93.220874, 41.98258], [-93.219879, 41.98361], [-93.224265, 41.985123], [-93.227241, 41.991225], [-93.231694, 41.99099], [-93.233565, 41.993417], [-93.236471, 41.994714], [-93.243199, 41.995979], [-93.246339, 41.998938], [-93.251186, 42.000217], [-93.251513, 42.001548], [-93.253068, 42.003097], [-93.255469, 42.003988], [-93.254545, 42.007267], [-93.254715, 42.009723], [-93.257428, 42.012265]]], "type": "Polygon"}, "id": "mergedCatchment", "properties": {}, "type": "Feature"}], "type": "FeatureCollection"}

However, if the input point does not intersect an NHD Flowline, or if 'upstream' is set to False, then the local catchment and the splitcatchment geometries will be returned.

.. code-block:: python

    splitcatchment(-93.02933761928982, 41.79037842455216, False)
    
.. image:: https://github.com/ACWI-SSWD/nldi_flowtools/blob/master/docs/images/splitcatchment2.png
   :width: 200

.. code_block:: python

    {"features": [{"geometry": {"coordinates": [[[-93.1822, 41.9681], [-93.1823, 41.9692], [-93.1834, 41.9696], [-93.1838, 41.9721], [-93.1831, 41.9733], [-93.1861, 41.9747], [-93.1873, 41.9759], [-93.1848, 41.978], [-93.1858, 41.979], [-93.1863, 41.9793], [-93.1866, 41.9796], [-93.1884, 41.9801], [-93.1889, 41.9827], [-93.1884, 41.9844], [-93.1864, 41.9842], [-93.1848, 41.9842], [-93.183, 41.9835], [-93.1806, 41.9821], [-93.179, 41.9834], [-93.1785, 41.9835], [-93.1773, 41.9837], [-93.1766, 41.984], [-93.1743, 41.9845], [-93.1729, 41.9863], [-93.1721, 41.9865], [-93.1709, 41.9872], [-93.1682, 41.9876], [-93.1671, 41.9879], [-93.1669, 41.9877], [-93.1655, 41.9872], [-93.1648, 41.9869], [-93.1625, 41.9865], [-93.1614, 41.9854], [-93.1614, 41.9851], [-93.1616, 41.985], [-93.1623, 41.9844], [-93.1637, 41.9829], [-93.1643, 41.9813], [-93.1651, 41.9802], [-93.1651, 41.9792], [-93.1655, 41.9762], [-93.1678, 41.9755], [-93.1693, 41.9747], [-93.1712, 41.9745], [-93.1711, 41.9731], [-93.172, 41.9729], [-93.1724, 41.9714], [-93.1739, 41.9696], [-93.1741, 41.9685], [-93.1748, 41.9684], [-93.1753, 41.968], [-93.1762, 41.9679], [-93.1763, 41.9677], [-93.178, 41.9676], [-93.1822, 41.9681]]], "type": "Polygon"}, "id": "catchment", "properties": {"catchmentID": "6995203"}, "type": "Feature"}, {"geometry": {"coordinates": [[[-93.170071, 41.987448], [-93.170082, 41.98718], [-93.170447, 41.987188], [-93.171176, 41.987204], [-93.171186, 41.986936], [-93.171551, 41.986944], [-93.171562, 41.986676], [-93.171926, 41.986684], [-93.171937, 41.986416], [-93.172301, 41.986424], [-93.17303, 41.98644], [-93.173052, 41.985904], [-93.173416, 41.985912], [-93.173438, 41.985376], [-93.173803, 41.985384], [-93.173824, 41.984848], [-93.174189, 41.984856], [-93.1742, 41.984587], [-93.174564, 41.984595], [-93.174575, 41.984327], [-93.174939, 41.984335], [-93.175668, 41.984351], [-93.175679, 41.984083], [-93.176043, 41.984091], [-93.176772, 41.984107], [-93.176783, 41.983839], [-93.177147, 41.983847], [-93.177158, 41.983579], [-93.177523, 41.983587], [-93.178616, 41.983611], [-93.178627, 41.983343], [-93.178991, 41.983351], [-93.179356, 41.983359], [-93.179377, 41.982823], [-93.179742, 41.982831], [-93.179753, 41.982562], [-93.180117, 41.98257], [-93.180128, 41.982302], [-93.180492, 41.98231], [-93.180503, 41.982042], [-93.180867, 41.98205], [-93.180857, 41.982318], [-93.181221, 41.982326], [-93.18121, 41.982594], [-93.181575, 41.982602], [-93.181564, 41.98287], [-93.182293, 41.982886], [-93.182282, 41.983154], [-93.182646, 41.983162], [-93.182635, 41.98343], [-93.183364, 41.983446], [-93.183353, 41.983714], [-93.184082, 41.98373], [-93.184072, 41.983998], [-93.1848, 41.984014], [-93.18479, 41.984282], [-93.186247, 41.984314], [-93.186258, 41.984046], [-93.186623, 41.984054], [-93.186612, 41.984322], [-93.188434, 41.984362], [-93.188466, 41.983557], [-93.188831, 41.983565], [-93.188895, 41.981957], [-93.188531, 41.981949], [-93.188596, 41.980341], [-93.188231, 41.980333], [-93.188242, 41.980065], [-93.187878, 41.980057], [-93.187888, 41.979789], [-93.186431, 41.979757], [-93.186452, 41.979221], [-93.185724, 41.979205], [-93.185745, 41.978669], [-93.185381, 41.978661], [-93.185392, 41.978393], [-93.185027, 41.978385], [-93.185038, 41.978117], [-93.184674, 41.978109], [-93.184695, 41.977573], [-93.183602, 41.977549], [-93.183613, 41.977281], [-93.182884, 41.977265], [-93.182895, 41.976997], [-93.182166, 41.976981], [-93.182177, 41.976713], [-93.181084, 41.976689], [-93.181073, 41.976957], [-93.178886, 41.976909], [-93.178897, 41.976641], [-93.178533, 41.976633], [-93.178522, 41.976901], [-93.178158, 41.976893], [-93.177793, 41.976885], [-93.177783, 41.977153], [-93.177418, 41.977146], [-93.177407, 41.977414], [-93.177043, 41.977406], [-93.176679, 41.977398], [-93.176657, 41.977934], [-93.176292, 41.977926], [-93.176282, 41.978194], [-93.175917, 41.978186], [-93.175906, 41.978454], [-93.175542, 41.978446], [-93.175531, 41.978714], [-93.175167, 41.978706], [-93.175156, 41.978974], [-93.174792, 41.978966], [-93.174802, 41.978698], [-93.174074, 41.978682], [-93.174063, 41.97895], [-93.173698, 41.978942], [-93.173687, 41.97921], [-93.173323, 41.979202], [-93.172959, 41.979194], [-93.172948, 41.979462], [-93.172583, 41.979454], [-93.172219, 41.979446], [-93.172208, 41.979715], [-93.171844, 41.979707], [-93.171479, 41.979699], [-93.171458, 41.980235], [-93.171093, 41.980227], [-93.171061, 41.981031], [-93.170696, 41.981023], [-93.170685, 41.981291], [-93.170321, 41.981283], [-93.17031, 41.981551], [-93.169946, 41.981543], [-93.169935, 41.981811], [-93.170299, 41.981819], [-93.170289, 41.982087], [-93.169924, 41.982079], [-93.169881, 41.983151], [-93.169516, 41.983143], [-93.169495, 41.98368], [-93.16913, 41.983672], [-93.169108, 41.984208], [-93.168744, 41.9842], [-93.168701, 41.985272], [-93.169065, 41.98528], [-93.169054, 41.985548], [-93.169419, 41.985556], [-93.169343, 41.987432], [-93.170071, 41.987448]]], "type": "Polygon"}, "id": "splitCatchment", "properties": {}, "type": "Feature"}], "type": "FeatureCollection"}
    
Flowtrace Tool
-----------------

The Flowtrace function traces the raindrop path from the input point to the NHD Flowline which it drains to. Depending on the inputs, this function can return the raindrop path from the input point to the flowline, and will always return either a portion or the entire NHD flowline. The function requires four input parameters. Like splitcatchment(), the first two inputs of flowtrace() are the longitude/latitude coordinates which are passed as floats. The third input is a boolean variable called raindropTrace, which if set as True, will ensure that the flowpath geometry will be returned. The four parameter is called 'direction' and is passed as a string. When flowtrace is run, it splits the NHD Flowline at the intersection point where the raindrop path flows into the NHD Flowline. If direction is set to 'up', then the upstream portion of the NHD Flowline will be returned. Likewise, if direction is set to 'down', the downstream portion will be returned. If direction is set as 'none', then the entire NHD Flowline will be returned.

.. code_block: python
    
    from nldi_flowtools import *
    flowtrace(-93.17298889291125, 41.99318001025908, True, 'down')
    
.. image:: https://github.com/ACWI-SSWD/nldi_flowtools/blob/master/docs/images/flowtrace1.png
   :width: 200

.. code_block:: python

    {"features": [{"geometry": {"coordinates": [[-93.1793, 41.9855], [-93.1791, 41.9851], [-93.1791, 41.9848], [-93.179, 41.9845], [-93.179, 41.9832]], "type": "LineString"}, "id": "downstreamFlowline", "properties": {"comid": 6994901, "gnis_name": "none", "intersectionPoint": [41.9855, -93.1793], "measure": 14.8, "raindropPathDist": 1159.24, "reachcode": "07080106000893"}, "type": "Feature"}, {"geometry": {"coordinates": [[-93.172936, 41.99328], [-93.172947, 41.993012], [-93.172958, 41.992744], [-93.173333, 41.992483], [-93.173344, 41.992215], [-93.173719, 41.991955], [-93.17373, 41.991687], [-93.174105, 41.991427], [-93.174116, 41.991159], [-93.174491, 41.990899], [-93.174502, 41.990631], [-93.174513, 41.990363], [-93.174888, 41.990103], [-93.175264, 41.989843], [-93.175628, 41.989851], [-93.176003, 41.989591], [-93.176368, 41.989598], [-93.176743, 41.989338], [-93.177119, 41.989078], [-93.177494, 41.988818], [-93.177869, 41.988558], [-93.177515, 41.988282], [-93.177526, 41.988014], [-93.177537, 41.987746], [-93.177548, 41.987478], [-93.177559, 41.98721], [-93.17757, 41.986942], [-93.177945, 41.986682], [-93.17832, 41.986422], [-93.178695, 41.986161], [-93.179071, 41.985901], [-93.179446, 41.985641], [-93.1793, 41.9855]], "type": "LineString"}, "id": "raindropPath", "properties": {}, "type": "Feature"}], "type": "FeatureCollection"}

.. code_block: python
    
    from nldi_flowtools import *
    flowtrace(-93.17298889291125, 41.99318001025908, False, 'down')
    
.. image:: https://github.com/ACWI-SSWD/nldi_flowtools/blob/master/docs/images/flowtrace2.png
   :width: 200

.. code_block:: python

